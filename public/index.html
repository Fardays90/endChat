<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat App</title>
    <link href="/src/output.css" rel="stylesheet">
    <style>
        
        body{
            background-color: rgba(0, 0, 0, 1);
            opacity: 1;
            background-image: radial-gradient(rgba(25,156,125,1) 1.5px, rgba(0, 0, 0, 1) 1.5px);
            background-size: 30px 30px;
            /* 47, 6, 195 */
            /* background-image: linear-gradient(to bottom right, rgb(0, 0, 0), rgb(25, 156, 125)); 
            background-repeat: no-repeat;
            background-size: cover;*/
            background-attachment: fixed; 
        }
        #DMbtn{
            background-color: rgba(4, 212, 136, 0.704);
            backdrop-filter: blur(10px);
        }
        #DMbtn:hover{
            background-color: rgba(4, 61, 67, 0.242);
            backdrop-filter: blur(10px);
        }
        #name{
            backdrop-filter: blur(10px);
            background-color: rgba(0, 0, 0, 0.235);
        }
        #submit-btn{
            background-color: rgba(255, 255, 255, 0.704);
            backdrop-filter: blur(5px);
        }
        #submit-btn{
            background-color: rgba(8, 130, 143, 0.242);
            backdrop-filter: blur(10px);
        }
        #submit-btn:hover{
            background-color: rgba(8, 130, 143, 0.626);
            backdrop-filter: blur(10px);
        }
        input:focus{
            outline:none;
            border:none;
        }
        #chatBox{
            backdrop-filter: blur(4px);
            z-index:0;
            background-color: rgba(41, 228, 206, 0.11);
        }
        #usernameDiv{
            backdrop-filter: blur(4px);
            z-index:0;
            background-color: rgba(41, 228, 207, 0.11);
        }
        #send{
            background-color: rgb(255, 255, 255);
            backdrop-filter: blur(10px);
        }
        #send:hover{
            background-color: rgba(0, 0, 0, 0.849);
            backdrop-filter: blur(10px);
        }
        #userModal{
            backdrop-filter: blur(4px);
            z-index:0;
            background-color: rgba(41, 228, 206, 0.11);
        }
    </style>
</head>
<body> 
    <div class="h-40 space-y-10" id="nameDiv">
        <h1 class="text-white text-4xl font-extralight text-center mt-28" style="z-index: 9999;">Welcome to the end</h1>
        <form class="flex flex-col w-96  mx-auto space-y-5" id="nameForm">
            <input class="text-center border-2 border-green-700 ease-in duration-300  valid:border-green-700 text-white  p-5 rounded-xl"  required  type="text" spellcheck="false" autocomplete="off" id="name" placeholder="Enter your name">
            <button  style="z-index: 9999;" class="p-3 w-24 self-center text-white rounded-xl hover:scale-110 transition-all duration-300 text-center  hover:text-white" id="submit-btn" type="submit">Confirm</button>
        </form>
    </div>
    <div id="chat" class="flex justify-between p-5 flex-row w-full ">
        <div class="flex rounded-xl  text-white justify-between p-3 w-[50vw] h-[75vh] flex-col" id="chatBox" >
            <div class="overflow-auto" id="messages"></div>
            <form class="sticky flex flex-row justify-between text-black border-t-2 border-white  p-3" id="form">
                <input id="input" class="bg-transparent text-white" autocomplete="off" placeholder="Type a message..." />
                <button class="p-3 transition-all duration-300 hover:text-white hover:scale-110 rounded-xl" id="send">Send</button>
            </form>
        </div>
        <div id="usernameDiv" class="rounded-xl  w-72 p-5 h-72 ">
            <h1 class="text-center text-white">Active users currently</h1>
            <div id="usersDiv" class="flex flex-col space-y-3 p-3 text-left text-blue-200 ">
            <!-- pop wit js -->
            </div>
            <div class="absolute flex flex-col bg-black p-4 space-y-5 rounded-xl" id="userModal"  style="display:none">
                <h1 class="text-lg" id="usernamay">Name of user</h1>
                <p id="nameOfTheUser"></p>            
                <button id="DMbtn" class="transition-all duration-300 ease-in-out p-4  text-white rounded-xl">DM</button>
            </div>
        </div>
  </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const nameForm = document.getElementById('nameForm');
        const submitName = document.getElementById('submit-btn');
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const nameInput = document.getElementById('name');
        const messages = document.getElementById('messages');
        const userNameBox = document.getElementById('usersDiv');
        const userModal = document.getElementById('userModal');
        let userName;
        let clickedOnUser = false;
        nameInput.addEventListener('invalid', (event) => {
            event.preventDefault();
            nameInput.classList.remove('border-green-700');
            nameInput.classList.add('border-red-400');
        })
        nameForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const userInput = document.getElementById('name').value.trim();
            if(userInput){
                nameInput.setCustomValidity('');
                event.preventDefault(); 
                userName = document.getElementById('name').value;
                document.getElementById('chat').style.display = '';
                document.getElementById('nameDiv').style.display = 'none';
                console.log(userName);
                socket.emit('username', userName);
            }
        })

        // Listen for form submission
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = input.value.trim();
            if (message) {
                socket.emit('chatMessage', message); // Send message to the server
                input.value = ''; // Clear input field
            }
        });
        socket.on('activeUsers', (usernames) => {
            userNameBox.innerHTML = '';
            for(let i = 0; i < usernames.length; i++){
                userP = document.createElement('p');
                userButton = document.createElement('button');
                userP.textContent = usernames[i];
                userButton.appendChild(userP);
                userButton.addEventListener('click' , (event) => {
                    event.preventDefault();
                    userModal.style.display = '';
                })
                userNameBox.appendChild(userButton);
            }
        })
        document.body.addEventListener('click',(event) => {
            const clickedOutsideDmBox = userModal.contains(event.target);


            if(!clickedOutsideDmBox){
                userModal.style.display = 'none';
            }
        })
        socket.on('chatMessage', ({userName, msg}) => {
            const item = document.createElement('div');
            item.textContent =userName+": " +  msg;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight; // Auto-scroll to the latest message
        });

        socket.on('userJoined', (str) => {
            const item = document.createElement('p');
            item.textContent = str;
            messages.appendChild(item);
        })
        socket.on('userDis', ({userName, leavingMsg}) => {
            const item = document.createElement('p');
            item.textContent = leavingMsg;
            messages.appendChild(item);
        })

        // document.body.appendChild(dmForm);
        // document.getElementById('dm-form').addEventListener('submit', (event) => {
        //     event.preventDefault();
        //     const sendingTo = document.getElementById('recipient').value;
        //     const message = document.getElementById('dm-input').value;
        //     if(sendingTo && message){
        //         socket.emit('dm', {personToSend:sendingTo , msg:message});
        //         document.getElementById('dm-input').value = '';
        //     }
        // })
        // socket.on('dm', ({from, msg}) => {
        //     const item = document.createElement('div');
        //     item.textContent = `DM from ${from}: ${msg}`;
        //     messages.appendChild(item);
        // })
    </script>
</body>
</html>
